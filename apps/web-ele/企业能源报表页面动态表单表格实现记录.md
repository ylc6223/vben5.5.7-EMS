# 企业能源报表页面动态表单表格实现记录

## 📋 实现概述

本次开发在企业能源报表页面中实现了动态表单和表格配置，根据标签页类型（月报/年报）自动调整时间字段显示、搜索表单组件和数据查询逻辑。

## 🎯 实现目标

1. **动态时间字段** - 月报显示"日期"，年报显示"月份"
2. **动态搜索表单** - 月报使用日期范围选择器，年报使用月份范围选择器
3. **动态数据查询** - 根据报表类型调整API参数和数据格式
4. **自动刷新机制** - 标签页切换时自动刷新对应表格

## 🔧 具体实现内容

### 1. 类型定义和列配置

**新增报表类型定义：**
```typescript
// 报表类型定义
export type ReportType = 'monthly' | 'yearly';
```

**动态列配置函数：**
```typescript
export function useColumns(
  reportType: ReportType = 'monthly',
  onActionClick?: OnActionClickFn<EnterpriseEnergyReportData>,
): VxeTableGridOptions<EnterpriseEnergyReportData>['columns'] {
  return [
    // 时间列 - 根据报表类型显示不同标题
    {
      align: 'center',
      field: 'time',
      fixed: 'left',
      title: reportType === 'monthly' 
        ? $t('system.energyReport.date') 
        : $t('system.energyReport.month'),
      width: 120,
    },
    // ... 其他列配置
  ];
}
```

### 2. 动态表单配置

**创建动态表单配置函数：**
```typescript
function createFormOptions(reportType: ReportType): VbenFormProps {
  const isMonthly = reportType === 'monthly';
  
  return {
    // 字段映射时间 - 根据报表类型调整格式
    fieldMappingTime: [
      [
        'time', 
        ['startTime', 'endTime'], 
        isMonthly ? 'YYYY-MM-DD' : 'YYYY-MM'
      ]
    ],
    schema: [
      {
        component: 'RangePicker',
        // 根据报表类型设置默认值
        defaultValue: isMonthly 
          ? [dayjs().subtract(7, 'days'), dayjs()]
          : [dayjs().subtract(11, 'months').startOf('month'), dayjs().endOf('month')],
        fieldName: 'time',
        label: isMonthly ? '日期范围' : '月份范围',
        componentProps: {
          startPlaceholder: isMonthly ? '开始日期' : '开始月份',
          endPlaceholder: isMonthly ? '结束日期' : '结束月份',
          format: isMonthly ? 'YYYY-MM-DD' : 'YYYY-MM',
          valueFormat: isMonthly ? 'YYYY-MM-DD' : 'YYYY-MM',
          // 年报使用月份选择器
          type: isMonthly ? 'daterange' : 'monthrange',
        },
      },
    ],
    // ... 其他配置
  };
}
```

### 3. 动态表格配置

**创建基础表格配置函数：**
```typescript
const createGridOptions = (reportType: ReportType) => ({
  columns: useColumns(reportType),
  height: 'auto',
  keepSource: true,
  showFooter: true,
  // ... 其他配置
});
```

**独立的表格实例：**
```typescript
// 月报表格
const [MonthlyGrid, monthlyGridApi] = useVbenVxeGrid({
  formOptions: createFormOptions('monthly'),
  showSearchForm: true,
  gridOptions: {
    ...createGridOptions('monthly'),
    proxyConfig: {
      ajax: {
        query: async (_params: any, formValues: any) => {
          const result = await getEnergyReportData({
            startTime: formValues?.startTime,
            endTime: formValues?.endTime,
            reportType: 'monthly',
          });
          // ... 处理逻辑
        },
      },
    },
  },
});

// 年报表格 - 类似配置，但使用 'yearly' 类型
```

### 4. 国际化支持

**中文翻译（zh-CN/system.json）：**
```json
{
  "energyReport": {
    "time": "时间",
    "date": "日期",
    "month": "月份"
  }
}
```

**英文翻译（en-US/system.json）：**
```json
{
  "energyReport": {
    "time": "Time",
    "date": "Date",
    "month": "Month"
  }
}
```

### 5. API接口增强

**前端API类型定义：**
```typescript
export interface EnterpriseEnergyReportParams {
  startTime?: string;
  endTime?: string;
  reportType?: 'monthly' | 'yearly';
}
```

**后端Mock API增强：**
```typescript
function generateDynamicMockData(
  startTime?: string, 
  endTime?: string, 
  reportType: 'monthly' | 'yearly' = 'monthly'
) {
  if (reportType === 'monthly') {
    // 月报：按日期生成数据，时间格式：YYYY-MM-DD
    // ... 日期循环逻辑
  } else {
    // 年报：按月份生成数据，时间格式：YYYY-MM
    // 数据量通常比月报大（月度汇总）
    // ... 月份循环逻辑
  }
}
```

### 6. 自动刷新机制

**标签页切换监听：**
```typescript
// 监听标签页切换，自动刷新对应表格
watch(activeTab, (newTab) => {
  setTimeout(() => {
    if (newTab === 'monthly') {
      monthlyGridApi.query();
    } else {
      yearlyGridApi.query();
    }
  }, 100);
});
```

## ✅ 实现效果

1. **✅ 动态时间字段** - 月报显示"日期"列，年报显示"月份"列
2. **✅ 动态搜索表单** - 月报使用日期范围选择器，年报使用月份范围选择器
3. **✅ 智能默认值** - 月报默认最近7天，年报默认最近12个月
4. **✅ 数据格式适配** - 月报数据按日显示，年报数据按月显示且数值更大
5. **✅ 自动刷新** - 切换标签页时自动查询对应数据
6. **✅ 国际化支持** - 支持中英文界面切换

## 🔍 技术要点

### 动态组件配置
- 根据业务逻辑动态生成表单和表格配置
- 使用工厂函数模式提高代码复用性
- 类型安全的参数传递

### 时间处理策略
- 月报：日期范围（YYYY-MM-DD）
- 年报：月份范围（YYYY-MM）
- 智能默认值设置

### 数据差异化
- 月报：日级别数据，数值相对较小
- 年报：月级别数据，数值为月度汇总（25-35倍）

### 用户体验优化
- 标签页切换自动刷新
- 延迟执行确保组件渲染完成
- 保持各自的搜索状态

## 📁 相关文件

| 文件路径 | 说明 |
|---------|------|
| `apps/web-ele/src/views/comprehensive_reports/enterprise_energy_report/index.vue` | 主页面组件 |
| `apps/web-ele/src/views/comprehensive_reports/enterprise_energy_report/data.ts` | 动态列配置 |
| `apps/web-ele/src/api/energy/report.ts` | API接口定义 |
| `apps/backend-mock/api/energy/report.get.ts` | Mock API实现 |
| `apps/web-ele/src/locales/langs/zh-CN/system.json` | 中文国际化 |
| `apps/web-ele/src/locales/langs/en-US/system.json` | 英文国际化 |

## 🚀 后续优化建议

1. **缓存优化** - 添加标签页数据缓存，避免重复查询
2. **加载状态** - 优化标签页切换时的加载体验
3. **数据验证** - 添加时间范围合理性验证
4. **性能优化** - 大数据量时的虚拟滚动支持

## 🐛 问题修复记录

### RangePicker 组件类型传递问题

**问题描述：**
年报页面的月份范围选择器仍然显示为日期选择器，无法正确切换到月份选择模式。

**问题原因：**
在 `apps/web-ele/src/adapter/component/index.ts` 中，`RangePicker` 组件的实现被硬编码为 `type: 'daterange'`，没有使用传入的 `type` 属性。

**修复前代码：**
```typescript
RangePicker: (props, { attrs, slots }) => {
  // ... 其他代码
  return h(ElDatePicker, {
    ...props,
    ...attrs,
    ...extraProps,
    type: 'daterange', // ❌ 硬编码，无法动态切换
  }, slots);
},
```

**修复后代码：**
```typescript
RangePicker: (props, { attrs, slots }) => {
  const { name, id, type } = props; // ✅ 提取 type 属性
  // ... 其他代码
  return h(ElDatePicker, {
    ...props,
    ...attrs,
    ...extraProps,
    type: type || 'daterange', // ✅ 使用传入的 type，默认为 daterange
  }, slots);
},
```

**修复效果：**
- ✅ 月报正确显示日期范围选择器（`daterange`）
- ✅ 年报正确显示月份范围选择器（`monthrange`）
- ✅ 支持 Element Plus DatePicker 的所有类型选项

## 📝 开发总结

本次实现成功将静态的表单表格升级为动态配置系统，根据业务需求自动调整界面和数据处理逻辑。通过工厂函数模式和类型安全的设计，确保了代码的可维护性和扩展性。用户现在可以在月报和年报之间无缝切换，每种报表都有适合的时间选择器和数据展示格式。

**关键修复：** 解决了 RangePicker 组件类型传递问题，确保年报能够正确显示月份范围选择器。
